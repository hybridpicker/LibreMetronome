#!/bin/bash
# Pre-push hook for LibreMetronome - Simplified version
# Runs basic checks before pushing

set -e

echo "ğŸš€ Running pre-push checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ROOT_DIR=$(git rev-parse --show-toplevel)

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)

print_info() {
    echo -e "${YELLOW}â†’ $1${NC}"
}

print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

# Don't run on main/master without confirmation
if [[ "$BRANCH" == "main" || "$BRANCH" == "master" ]]; then
    echo -e "${YELLOW}âš ï¸  You're pushing to $BRANCH branch!${NC}"
    read -p "Are you sure you want to continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Basic Django check
cd "$ROOT_DIR/backend"
if [ -d "../venv" ]; then
    source ../venv/bin/activate
elif [ -d "venv" ]; then
    source venv/bin/activate
fi

print_info "Running Django checks..."
python manage.py check 2>/dev/null || {
    print_error "Django check failed - but continuing anyway"
}
print_success "Django checks completed"

# Check for migrations
print_info "Checking migrations..."
python manage.py makemigrations --check --dry-run 2>/dev/null || {
    print_info "There might be missing migrations"
}

print_success "All pre-push checks completed! ğŸ‰"
